#!/bin/bash

shortname() {
    echo "staging"
}

name() {
    echo "$(shortname) io=$(iolib_id_to_name $iolib) head=$head"
}

setup() {
    # Constants
    app='staging/massive.exe'
    iolib="$(iolib_name_to_id 'POSIX')"

    # Input
    head=$1

    # Config file manipulation
    fti_config_set "ckpt_io" "$iolib"
    fti_config_set "head" "$head"

    fti_config_set 'enable_staging' '1'
    fti_config_set 'ckpt_l1' '0'
    fti_config_set 'ckpt_l2' '1'
    fti_config_set 'ckpt_l3' '3'
    fti_config_set 'ckpt_l4' '0'
}

teardown() {
    unset iolib
    unset head
    unset app
}

runtest() {
    app_run_success $app $itf_cfgfile
    
    awk '/of staging completed/ { PROGRESS=$2*1.0; }
        END { if ( PROGRESS != 100.00 ) {print "!"; exit(-1)} }
    ' $itf_tstdout
    
    check_is_zero $? 'Staging incomplete'

    awk '/of staging completed/ { FILES_DONE=$7; FILES_TODO=$9; }
        END { if ( FILES_DONE != FILES_TODO ) { exit(-1) }
        } 
    ' $itf_tstdout

    assert_equals $? 0 'Number of files differ'
}
