#!/bin/bash

shortname() {
    echo "standard-h0k1"
}

name() {
    echo "$(shortname) io=$(iolib_id_to_name $iolib) ICP=$icp L=$level diffsize=$diffsize erase_ckpt=$erase head=0 keep=1 inline=(1,1,1)"
}

setup() {
    # Constants
    app='check.exe'

    # Input
    iolib=$1
    level=$2
    icp=$3
    erase=$4
    diffsize=$5

    # Configuration file manipulation
    fti_config_set 'ckpt_io' "$iolib"
    fti_config_set 'keep_last_ckpt' '1'
    fti_config_set_inline
}

teardown() {
    unset app

    unset iolib
    unset level
    unset icp
    unset erase
    unset diffsize
}

runtest() {
    app_run $app $itf_cfgfile 0 $level $diffsize $icp

    fti_config_set 'keep_last_ckpt' '0' # Setting keep=0 to clean dir after test
    if [ $erase -ne 0 ]; then
        ckpt_delete_global 'l4' '1'
    fi

    app_run_interrupt $app $itf_cfgfile 0 $level $diffsize $icp

    local retv=$?
    if [ $erase -eq 0 ]; then
        assert_equals $retv 0 'FTI should recover when files are not touched'
    else
        assert_not_equals $retv 0 'FTI should fail when checkpoint files are deleted'
    fi
}
