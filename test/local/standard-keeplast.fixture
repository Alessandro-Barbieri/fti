#!/bin/bash

shortname() {
    echo "standard-keeplast"
}

name() {
    echo "$(shortname) io=$(iolib_id_to_name $iolib) ICP=$icp L=$level diffsize=$diffsize erase_ckpt=$erase head=$head keep=1 inline=(1,1,1)"
}

setup() {
    # Constants
    app='check.exe'

    # Input
    iolib=$1 # values 1-5
    level=$2 # values 1-4
    icp=$3 $ # values 0-1
    erase=$4 # values 0-1
    diffsize=$5 # values 0-1
    head=$6 # values 0-1

    # Configuration file manipulation
    fti_config_set 'ckpt_io' "$iolib"
    fti_config_set 'keep_last_ckpt' '1'
    fti_config_set 'head' $head
    fti_config_set_inline
    
    if [ $head -ne 1 ]; then
        fti_config_set "inline_l$level" '0'
    fi
}

teardown() {
    unset app

    unset iolib
    unset level
    unset icp
    unset erase
    unset diffsize
    unset head
}

runtest() {
    app_run $app $itf_cfgfile 0 $level $diffsize $icp

    fti_config_set 'keep_last_ckpt' '0' # Setting keep=0 to clean dir after test
    if [ $erase -ne 0 ]; then
        ckpt_delete_global 'l4' '1'
    fi

    app_run_interrupt $app $itf_cfgfile 0 $level $diffsize $icp

    local retv=$?
    if [ $erase -eq 0 ]; then
        assert_equals $retv 0 'FTI should recover when files are not touched'
    else
        assert_not_equals $retv 0 'FTI should fail when checkpoint files are deleted'
    fi
}
