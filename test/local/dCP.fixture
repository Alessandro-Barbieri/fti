#!/bin/bash

shortname() {
    echo "dCP"
}

name() {
    echo "$(shortname) io=$(iolib_id_to_name $iolib) head=$head, test_mode=$TEST_MODE"
}

setup() {
    iolib=$(iolib_name_to_id 'POSIX')
    app='diffckpt/diff_test.exe'

    head=$1
    if [ $2 -eq 0 ]; then
        export TEST_MODE='NOICP'
    else
        export TEST_MODE='ICP'
    fi

    fti_config_set "ckpt_io" "$iolib"
    fti_config_set "head" "$head"

    fti_config_set "enable_dcp" '1'
    fti_config_set "dcp_mode" '1'
    fti_config_set 'ckpt_l1' '2'

    fti_config_set 'inline_l2' '1'
    fti_config_set 'inline_l3' '1'
    fti_config_set 'inline_l4' '1'
    
    fti_config_set "dcp_block_size" '4096'
    fti_config_set "dcp_stack_size" '10'
}

teardown() {
    unset iolib
    unset head
    unset app
    unset TEST_MODE
}

runtest() {
    for i in 0 1
    do
        app_run $app $itf_cfgfile
        if [ $? -ne 0]; then
            fail "Test application $app failed to execute until completion"
            return $?
        fi
    done

    awk '
        BEGIN {VAL=100; dcpEnabled=0};
        /L4 dCP requested, but dCP is disabled!/ {exit(-1)}
        /FTI  dCP Message/ {dcpEnabled=1};
        /DEBUG/ {VAL=$10}; 
        /Total CP data/ && (($19*1.0)<VAL || ($19*1.0)>(VAL+2)) {exit(-1)}; 
        /Ckpt. ID 7/ {VAL=0}
        END { if ( !dcpEnabled ) {exit(-1)} } 
        ' $itf_tstdout
    if [ $? -eq 0 ]; then
        assert_equals $(grep $TEST_MODE $itf_tstdout | wc -l) $itf_nranks \
        'There should be dCP messages for every rank'
    else
        fail 'Application log could not be validated in awk'
    fi
}
