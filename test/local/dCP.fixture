#!/bin/bash

setup() {
    # Constants
    app='diffckpt/diff_test.exe'

    # Input
    itf_param_register_std 'iolib' 'head'
    itf_param_register_fxt 'mode'
}

prepare_fti() {
    fti_config_set_inline

    fti_config_set "enable_dcp" '1'
    fti_config_set "dcp_mode" '1'
    fti_config_set 'ckpt_l1' '2'

    fti_config_set "dcp_block_size" '4096'
    fti_config_set "dcp_stack_size" '10'
}

runtest() {
    export TEST_MODE=$mode

    for i in 0 1
    do
        app_run_success $app $itf_cfgfile
    done

    awk '
        BEGIN {dcpEnabled=0};
        /L4 dCP requested, but dCP is disabled!/ {exit(-1)}
        /FTI  dCP Message/ {dcpEnabled=1};
        END { if ( !dcpEnabled ) {exit(-1)} } 
        ' $itf_tstdout
    check_is_zero $? 'dCP is disabled'

    awk '
        BEGIN {VAL=100;};
        /DEBUG/ {VAL=$10}; 
        /Total CP data/ && (($19*1.0)<VAL || ($19*1.0)>(VAL+2)) {exit(-1)}; 
        /Ckpt. ID 7/ {VAL=0}
        ' $itf_tstdout
    check_is_zero $? 'dCP encoded size differ'

    assert_equals $(grep $TEST_MODE $itf_tstdout | wc -l) $itf_nranks \
        'There should be dCP messages for every rank'
}

teardown() {
    unset app
    unset TEST_MODE
}
